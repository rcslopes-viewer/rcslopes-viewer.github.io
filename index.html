<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
        <link rel="stylesheet" href="css/leaflet-search.css" />
        <style type="text/css">
        html, body, #map {
           height:100%;
           width:100%;
           padding:0px;
           margin:0px;
        }
        </style>
        <title>OSM Map - Rcslopes</title>
    </head>
    <body>
        <div id="map"></div>
        <!-- Make sure you put this AFTER Leaflet's CSS -->
        <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>
        <!-- https://github.com/stefanocudini/leaflet-search -->
        <script src="js/leaflet-search.js"></script>
	<script type="text/javascript">
            var lat = 46.227638;
            var lon = 2.213749;

            var slopes = L.layerGroup();   // Pente
            var slopesP1 = L.layerGroup(); // Parking
            var slopesP2 = L.layerGroup();
            var slopesP3 = L.layerGroup();
            slopes.getAttribution = function() { return '<a href="https://www.rc-slopes.com">RC-Slopes</a>'; };

            // Fonction d'initialisation de la carte
            function initMap() {

              var Esri_WorldImagery = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                  attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, ' +
                  'AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community</a>'
                   });

              // var Esri_WorldTopoMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
	      //    attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, ' +
              //    'FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community'
              //});

              var OpenStreetMapFR = L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
                  maxZoom: '17',
                  attribution: 'données © <a href="//openstreetmap.fr">OpenStreetMap</a>'
                   });

              var OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
	          maxZoom: '19',
	          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    });

              var OpenTopoMap = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                  maxZoom: '17',
                  attribution: 'données © <a href="//opentopomap.org/">OpenTopoMap</a>'
                   });

              var baseLayers = {
                 "Vue Satellite": Esri_WorldImagery,
                 // "World Topo": Esri_WorldTopoMap,
                 "OSM FR": OpenStreetMapFR,
                 "OSM Mapnik": OpenStreetMap_Mapnik,
                 "OpenTopoMap": OpenTopoMap
              };


	      var map = L.map('map', {
		center: [lat, lon],
		zoom: 6,
		layers: [Esri_WorldImagery, slopes]
	      });

	      var overlays = {
		"Pentes": slopes,
		"Parking": slopesP1,
		"P2": slopesP2,
		"P3": slopesP3
 	      };

	      L.control.layers(baseLayers, overlays).addTo(map);

              map.addControl(new L.Control.Scale({maxWidth: 200, position: 'bottomleft', imperial: false}));

              map.addControl( new L.Control.Search({
                 url: 'https://nominatim.openstreetmap.org/search?format=json&accept-language=fr-FR&q={s}',
                 jsonpParam: 'json_callback',
                 propertyName: 'display_name',
                 propertyLoc: ['lat','lon'],
                 markerLocation: true,
                 autoType: false,
                 autoCollapse: true,
                 minLength: 2,
                 zoom:14,
                 position:'topleft',
                 textPlaceholder: 'Recherche par lieu...',
                 textCancel: 'Annuler',
                 textErr: 'Aucun résultat trouvé',
              }) );

              map.addControl( new L.Control.Search({
                 layer: slopes,
                 position:'topright',
                 initial: false,
                 zoom:14,
                 textPlaceholder: 'Recherche par pente/département...',
                 textCancel: 'Annuler',
                 textErr: 'Aucune pente trouvée',
              }) );
            }

            function loadXMLDoc() {
               var xmlhttp = new XMLHttpRequest();
               xmlhttp.onreadystatechange = function() {
                  if (this.readyState == 4 && this.status == 200) {
                     myFunction(this);
                  }
               };
               xmlhttp.open("GET", "rc-slopes-data.xml", true);
               xmlhttp.send();
            }

            function myFunction(xml) {
                var x, nom, i, xmlDoc, txt, marker, info;
                xmlDoc = xml.responseXML;
                txt = "";
                x = xmlDoc.getElementsByTagName("marker");
                nom = xmlDoc.getElementsByTagName("nom");

                for (i = 0; i< x.length; i++) {
                 info =  "<h3>" + nom[i].childNodes[0].nodeValue + "</h3>";
                 info += "<ul><li>" + x[i].getAttribute('latlng2') + "</li>";
                 info += "<li>" + x[i].getAttribute('lat') + ", " + x[i].getAttribute('lng') + "</li></ul>";
                 info += "<p>Description : " + x[i].getAttribute('legendeFR') + "</p><br>Ajoutée le " + x[i].getAttribute('dat') 
                 var author = x[i].getAttribute('psd');
                 if (author != "0") {
                     info += " par " + author;
                 }
                 marker = L.marker([x[i].getAttribute('lat'), x[i].getAttribute('lng')], {title: nom[i].childNodes[0].nodeValue + " - " + x[i].getAttribute('dep')}).addTo(slopes);

                 marker.bindPopup(info);
                 info =  "<h3>" + nom[i].childNodes[0].nodeValue + "</h3>";
                 marker = L.marker([x[i].getAttribute('latP1'), x[i].getAttribute('lngP1')]).addTo(slopesP1);
                 marker.bindPopup(info + " Parking" + "<ul><li>" + x[i].getAttribute('latlng2P1') + "</li>" + "<li>" + x[i].getAttribute('latP1') + ", " + x[i].getAttribute('lngP1') + "</li></ul>");
                 marker = L.marker([x[i].getAttribute('latP2'), x[i].getAttribute('lngP2')]).addTo(slopesP2);
                 marker.bindPopup(info + " P2" + "<ul><li>" + x[i].getAttribute('latlng2P2') + "</li>" + "<li>" + x[i].getAttribute('latP2') + ", " + x[i].getAttribute('lngP2') + "</li></ul>");
                 marker = L.marker([x[i].getAttribute('latP3'), x[i].getAttribute('lngP3')]).addTo(slopesP3);
                 marker.bindPopup(info + " P3" + "<ul><li>" + x[i].getAttribute('latlng2P3') + "</li>" + "<li>" + x[i].getAttribute('latP3') + ", " + x[i].getAttribute('lngP3') + "</li></ul>");

                 }
            }

            window.onload = function(){
		initMap(); 
                loadXMLDoc();
            };
         </script>
    </body>
</html>
